<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENEM AI - Chat com Agentes Especializados</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Poppins:wght@400;500&display=swap" rel="stylesheet">
    <meta name="description" content="Chat ENEM AI: converse com agentes inteligentes, tire d√∫vidas e aprenda de forma personalizada.">
    <meta name="keywords" content="ENEM, chat, intelig√™ncia artificial, tutores, d√∫vidas, educa√ß√£o, tecnologia">
    <style>
        :root {
            --cor-primaria: #7F00FF;
            --cor-secundaria: #00C3FF;
            --cor-destaque: #FF61A6;
            --cor-fundo: #1A1A2E;
            --cor-branco: #FFFFFF;
            --fonte-titulo: 'Montserrat', sans-serif;
            --fonte-texto: 'Poppins', sans-serif;
            /* Sidebar moderna */
            --sidebar: #35355a;
            --sidebar-foreground: #f8f8fa;
            --sidebar-primary: #6c4cff;
            --sidebar-primary-foreground: #f8f8fa;
            --sidebar-accent: #444444;
            --sidebar-accent-foreground: #f8f8fa;
            --sidebar-border: rgba(255,255,255,0.1);
            --sidebar-ring: #707070;
            --sidebar-btn-bg: var(--cor-primaria);
            --sidebar-btn-hover: var(--cor-secundaria);
            --sidebar-btn-active: var(--cor-destaque);
            --sidebar-btn-border: #fff;
            --sidebar-btn-shadow: var(--cor-primaria);
        }
        body {
            font-family: var(--fonte-texto);
            background: linear-gradient(135deg, var(--cor-primaria) 0%, var(--cor-fundo) 100%);
            min-height: 100vh;
            color: var(--cor-branco);
            margin-left: 60px;
            transition: margin-left 0.3s;
            overflow-x: hidden;
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--fonte-titulo);
        }
        /* Cards e bot√µes modernos */
        .rounded-xl, .rounded-lg, .rounded-full {
            border-radius: 1.5rem !important;
        }
        .glass-card, .shadow-2xl, .shadow-lg, .agent-card {
            box-shadow: 0 8px 32px rgba(127,0,255,0.10), 0 1.5px 4px rgba(0,0,0,0.04) !important;
        }
        .bg-purple-600, .bg-pink-600, .bg-blue-600, .bg-green-600, .bg-yellow-600, .bg-gray-700 {
            border-radius: 9999px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(127,0,255,0.10);
            transition: background 0.3s, color 0.3s, box-shadow 0.3s;
        }
        .bg-purple-600:hover, .bg-pink-600:hover, .bg-blue-600:hover, .bg-green-600:hover, .bg-yellow-600:hover, .bg-gray-700:hover {
            background: var(--cor-secundaria) !important;
            color: var(--cor-branco) !important;
            box-shadow: 0 4px 16px rgba(127,0,255,0.18);
        }
        /* Remover efeito hover azul claro das mensagens de chat */
        .chat-message .inline-block:hover {
            background: inherit !important;
        }
        /* Remover efeito hover azul claro da caixa de texto */
        #message-input:hover {
            background: #4B5563 !important; /* bg-gray-700 */
        }
        /* Microintera√ß√µes e acessibilidade */
        a, button, input {
            outline: none;
            transition: box-shadow 0.2s, border 0.2s, background 0.2s, color 0.2s;
        }
        a:focus-visible, button:focus-visible, input:focus-visible {
            box-shadow: 0 0 0 3px var(--cor-secundaria), 0 0 0 6px var(--cor-branco);
            border: 2px solid var(--cor-secundaria);
        }
        /* Contraste aprimorado */
        .text-gray-900, .font-bold, h1, h2, h3, h4, h5, h6 {
            color: #fff !important;
            text-shadow: 0 2px 8px rgba(0,0,0,0.10);
        }
        .text-gray-600, .text-gray-500, .text-gray-400, .text-gray-300 {
            color: #e0e0e0 !important;
        }
        /* Responsividade */
        @media (max-width: 1024px) {
            .rounded-xl, .rounded-lg { border-radius: 1rem !important; }
        }
        @media (max-width: 768px) {
            .rounded-xl, .rounded-lg { border-radius: 0.7rem !important; }
        }
        /* Anima√ß√£o fade-in para as se√ß√µes */
        .fade-section {
            opacity: 0;
            transform: translateY(40px);
            transition: opacity 0.8s cubic-bezier(0.4,0,0.2,1), transform 0.8s cubic-bezier(0.4,0,0.2,1);
        }
        .fade-section.visible {
            opacity: 1;
            transform: translateY(0);
        }
        /* Shapes decorativos SVG */
        .shape-bg {
            position: absolute;
            z-index: 0;
            pointer-events: none;
        }
        .shape1 { top: -60px; left: -60px; width: 180px; opacity: 0.18; }
        .shape2 { bottom: -80px; right: -80px; width: 220px; opacity: 0.13; }
        .shape3 { top: 40%; left: 80%; width: 120px; opacity: 0.10; }
        body.dark {
            --sidebar: #35355a;
            --sidebar-foreground: #f8f8fa;
            --sidebar-primary: #6c4cff;
            --sidebar-primary-foreground: #f8f8fa;
            --sidebar-accent: #444444;
            --sidebar-accent-foreground: #f8f8fa;
            --sidebar-border: rgba(255,255,255,0.1);
            --sidebar-ring: #707070;
        }
        .sidebar {
            position: fixed;
            top: 0; left: 0; bottom: 0;
            width: 60px;
            background: var(--sidebar);
            color: var(--sidebar-foreground);
            border-right: 1px solid var(--sidebar-border);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: width 0.5s cubic-bezier(0.4,0,0.2,1);
        }
        .sidebar:hover, .sidebar:focus-within {
            width: 220px;
        }
        .sidebar-site-logo {
            width: 100%;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            flex-direction: row;
            gap: 0.7em;
            margin-bottom: 0.5em;
            position: relative;
            transition: justify-content 0.4s;
        }
        .sidebar-site-logo i {
            font-size: 2.2em;
            color: #fff;
            transition: font-size 0.4s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-logo-text {
            color: #fff;
            font-family: var(--fonte-titulo);
            font-size: 1.3em;
            font-weight: bold;
            margin-left: 0.3em;
            white-space: nowrap;
            letter-spacing: 1px;
            opacity: 0;
            max-width: 0;
            width: 0;
            padding: 0;
            overflow: hidden;
            transition: opacity 0.4s, max-width 0.4s, width 0.4s, margin 0.4s, padding 0.4s;
            display: inline-block;
            vertical-align: middle;
        }
        .sidebar:not(:hover):not(:focus-within) .sidebar-site-logo {
            justify-content: center;
        }
        .sidebar:not(:hover):not(:focus-within) .sidebar-logo-text {
            opacity: 0;
            max-width: 0;
            width: 0;
            padding: 0;
            margin: 0;
        }
        .sidebar:hover .sidebar-site-logo,
        .sidebar:focus-within .sidebar-site-logo {
            justify-content: flex-start;
        }
        .sidebar:hover .sidebar-logo-text,
        .sidebar:focus-within .sidebar-logo-text {
            opacity: 1;
            max-width: 90px;
            width: auto;
            margin-left: 0.3em;
            padding: 0;
        }
        .sidebar-header {
            height: 70px;
            border-bottom: 1px solid var(--sidebar-border);
        }
        .sidebar-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
            padding: 1.2rem 0.8rem 0.5rem 0.5rem;
            align-items: flex-start;
        }
        .sidebar-btn {
            width: 100%;
            background: none;
            border: none;
            outline: none;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            position: relative;
            border-radius: 7px;
            box-shadow: 0 1px 0 1px var(--sidebar-btn-shadow);
            border: 1.2px solid var(--sidebar-btn-border);
            padding: 0.25em 0.3em;
            font-size: 10px;
            color: #fff;
            font-weight: 600;
            background-color: var(--sidebar-btn-bg);
            overflow: hidden;
            min-height: 32px;
            height: 36px;
            transition: all 0.25s cubic-bezier(0.4,0,0.2,1);
        }
        .sidebar-btn .circle-icon {
            width: 18px;
            height: 18px;
            font-size: 0.9em;
            color: #fff !important;
            background: transparent !important;
            box-shadow: none !important;
            transition: color 0.2s, margin 0.2s, left 0.2s;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sidebar-btn .sidebar-label {
            display: none;
            margin-left: 0.5em;
            font-size: 0.90em;
            color: #fff;
            font-weight: 500;
            z-index: 2;
        }
        .sidebar:hover .sidebar-btn .sidebar-label,
        .sidebar:focus-within .sidebar-btn .sidebar-label {
            display: inline;
        }
        /* Centralizar √≠cone quando sidebar retra√≠da */
        .sidebar:not(:hover):not(:focus-within) .sidebar-btn {
            justify-content: center;
        }
        .sidebar:not(:hover):not(:focus-within) .sidebar-btn .circle-icon {
            margin: 0;
        }
        .sidebar:not(:hover):not(:focus-within) .sidebar-btn .sidebar-label {
            display: none !important;
        }
        .sidebar-btn:before {
            content: "";
            position: absolute;
            width: 70px;
            height: 120%;
            background-color: var(--sidebar-btn-active);
            top: 50%;
            left: 0;
            transform: skewX(30deg) translate(-150%, -50%);
            transition: all 0.5s;
            z-index: 1;
        }
        .sidebar-btn:hover, .sidebar-btn:focus {
            background-color: var(--sidebar-btn-hover);
            color: #fff;
            box-shadow: 0 2px 0 2px var(--cor-secundaria);
        }
        .sidebar-btn:hover:before, .sidebar-btn:focus:before {
            transform: skewX(30deg) translate(150%, -50%);
            transition-delay: 0.1s;
        }
        .sidebar-btn:active {
            transform: scale(0.95);
        }
        .sidebar-user {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            padding: 1.2rem 1rem 1.2rem 1.1em;
            border-top: 1px solid var(--sidebar-border);
            transition: opacity 0.3s;
            margin-top: auto;
        }
        .sidebar-avatar {
            max-width: 32px;
            min-width: 32px;
            min-height: 32px;
            max-height: 32px;
            border-radius: 50%;
            border: 2px solid var(--sidebar-primary);
            background: #fff;
            color: var(--sidebar-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1em;
        }
        .sidebar-username {
            font-size: 1em;
            font-weight: 500;
            color: var(--sidebar-foreground);
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .sidebar:hover .sidebar-username, .sidebar:focus-within .sidebar-username {
            opacity: 1;
        }
        @media (max-width: 900px) {
            .sidebar {
                width: 60px !important;
            }
            .sidebar:hover, .sidebar:focus-within {
                width: 180px !important;
            }
        }
    </style>
</head>
<body class="font-sans sidebar-dark">
    <!-- Sidebar moderna padronizada -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-site-logo">
            <img src="images/logo.png" alt="Logo EnemAI" class="sidebar-logo-img" style="height:48px;width:48px;min-width:48px;min-height:48px;max-width:48px;max-height:48px;margin:0 0.5em 0 0.5em;display:block;object-fit:cover;border-radius:50%;box-shadow:0 2px 8px rgba(0,0,0,0.10);" />
            <span class="sidebar-logo-text">EnemAI</span>
        </div>
        <div class="sidebar-header"></div>
        <style>
            /* Exibe a logo sempre, mas oculta quando sidebar est√° retra√≠da (n√£o hover/focus) */
            .sidebar .sidebar-logo-img {
                height: 48px !important;
                width: 48px !important;
                min-width: 48px !important;
                min-height: 48px !important;
                max-width: 48px !important;
                max-height: 48px !important;
                margin: 0 0.5em 0 0.5em !important;
                display: block !important;
                object-fit: cover !important;
                border-radius: 50% !important;
                box-shadow: 0 2px 8px rgba(0,0,0,0.10);
                transition: opacity 0.3s ease;
                opacity: 1 !important;
            }
            .sidebar:not(:hover):not(:focus-within) .sidebar-logo-img {
                opacity: 0 !important;
            }
        </style>
        <nav class="sidebar-content">
            <a href="main-dashboard.html" class="sidebar-btn">
                <div class="circle-icon"><i class="fas fa-tachometer-alt"></i></div>
                <span class="sidebar-label">Dashboard</span>
            </a>
            <a href="ai-chat.html" class="sidebar-btn active">
                <div class="circle-icon active"><i class="fas fa-robot"></i></div>
                <span class="sidebar-label">Chat IA</span>
            </a>
            <a href="settings.html" class="sidebar-btn">
                <div class="circle-icon"><i class="fas fa-cog"></i></div>
                <span class="sidebar-label">Configura√ß√µes</span>
            </a>
            <a href="community.html" class="sidebar-btn">
                <div class="circle-icon"><i class="fas fa-users"></i></div>
                <span class="sidebar-label">Comunidade</span>
            </a>
            <a href="dashboard.html" class="sidebar-btn" id="sidebar-new-note-btn">
                <div class="circle-icon"><i class="fas fa-plus"></i></div>
                <span class="sidebar-label">Nova Nota</span>
            </a>
        </nav>
        <div class="sidebar-user">
            <div class="sidebar-avatar" id="sidebar-avatar">US</div>
            <span class="sidebar-username" id="sidebar-username">Usu√°rio</span>
        </div>
    </aside>
    <!-- Fim da sidebar padronizada -->
    <script>
    // Sidebar din√¢mica: avatar e nome
    (function() {
        const sidebarAvatar = document.getElementById('sidebar-avatar');
        const sidebarUsername = document.getElementById('sidebar-username');
        function updateSidebarUser() {
            const user = JSON.parse(localStorage.getItem('enemai_user'));
            if (!user) return;
            sidebarUsername.textContent = user.name || 'Usu√°rio';
            if (user.avatar) {
                sidebarAvatar.innerHTML = `<img src="${user.avatar}" alt="Avatar" style="width:100%;height:100%;border-radius:50%">`;
            } else {
                const initials = (user.name||'Usu√°rio').split(' ').map(n=>n[0]).join('').toUpperCase().slice(0,2);
                sidebarAvatar.textContent = initials;
            }
        }
        updateSidebarUser();
    })();
    </script>
    <!-- Shapes SVG decorativos -->
    <svg class="shape-bg shape1" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="100" cy="100" rx="100" ry="100" fill="url(#paint0_radial)"/></svg>
    <svg class="shape-bg shape2" viewBox="0 0 220 220" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="110" cy="110" rx="110" ry="110" fill="url(#paint1_radial)"/></svg>
    <svg class="shape-bg shape3" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg"><ellipse cx="60" cy="60" rx="60" ry="60" fill="url(#paint2_radial)"/></svg>
    <defs>
      <radialGradient id="paint0_radial" cx="0.5" cy="0.5" r="0.5" gradientUnits="objectBoundingBox">
        <stop stop-color="#7F00FF"/>
        <stop offset="1" stop-color="#00C3FF"/>
      </radialGradient>
      <radialGradient id="paint1_radial" cx="0.5" cy="0.5" r="0.5" gradientUnits="objectBoundingBox">
        <stop stop-color="#FF61A6"/>
        <stop offset="1" stop-color="#7F00FF"/>
      </radialGradient>
      <radialGradient id="paint2_radial" cx="0.5" cy="0.5" r="0.5" gradientUnits="objectBoundingBox">
        <stop stop-color="#00C3FF"/>
        <stop offset="1" stop-color="#FF61A6"/>
      </radialGradient>
    </defs>
    <!-- Header -->
    <header class="glass-card shadow-sm border-b border-gray-600">
        <div class="container mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-brain text-2xl text-purple-400"></i>
                    <h1 class="text-xl font-bold text-gray-100">ENEM AI - Chat Especializado</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="main-dashboard-btn" class="bg-purple-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-purple-700 transition">
                        <i class="fas fa-home mr-2"></i>Dashboard Principal
                    </button>
                    <button id="community-btn" class="bg-pink-600 text-white px-3 py-2 rounded-lg text-sm hover:bg-pink-700 transition" title="Comunidade">
                        <i class="fas fa-users"></i> Comunidade
                    </button>
                    <button id="settings-btn" class="bg-gray-700 text-white px-3 py-2 rounded-lg text-sm hover:bg-gray-800 transition" title="Configura√ß√µes">
                        <i class="fas fa-cog"></i>
                    </button>
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-full bg-purple-900 flex items-center justify-center">
                            <i class="fas fa-user text-purple-300 text-sm"></i>
                        </div>
                        <span id="user-name" class="font-medium text-gray-200"></span>
                    </div>
                    <button id="logout-btn" class="text-gray-400 hover:text-gray-200 transition">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8 fade-section">
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Sidebar - Hist√≥rico de Conversas -->
            <div class="lg:col-span-1">
                <div class="glass-card rounded-xl p-6 h-fit">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-100">Conversas</h3>
                        <button id="new-chat-btn" class="bg-purple-600 text-white p-2 rounded-lg hover:bg-purple-700 transition" title="Nova conversa">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div id="conversations-list" class="space-y-2 max-h-96 overflow-y-auto scrollbar-hide">
                        <!-- Conversas ser√£o carregadas aqui -->
                    </div>
                </div>
            </div>

            <!-- Main Chat Area -->
            <div class="lg:col-span-4">
                <div class="glass-card rounded-xl p-6">
                    <!-- Sele√ß√£o de Agentes -->
                    <div class="mb-6">
                        <h2 class="text-xl font-bold text-gray-100 mb-4">Escolha seu Tutor Especializado</h2>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                            <!-- S√≥crates - Humanas -->
                            <div class="agent-card bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-4 text-center" data-agent="socrates">
                                <div class="w-16 h-16 mx-auto mb-3 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-landmark text-2xl"></i>
                                </div>
                                <h3 class="font-bold text-lg mb-1">S√≥crates</h3>
                                <p class="text-sm opacity-90">Humanas</p>
                                <p class="text-xs opacity-75 mt-1">Hist√≥ria, Geografia, Filosofia</p>
                            </div>

                            <!-- Pit√°goras - Exatas -->
                            <div class="agent-card bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-4 text-center" data-agent="pitagoras">
                                <div class="w-16 h-16 mx-auto mb-3 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-calculator text-2xl"></i>
                                </div>
                                <h3 class="font-bold text-lg mb-1">Pit√°goras</h3>
                                <p class="text-sm opacity-90">Exatas</p>
                                <p class="text-xs opacity-75 mt-1">Matem√°tica, F√≠sica, Qu√≠mica</p>
                            </div>

                            <!-- Cam√µes - Linguagens -->
                            <div class="agent-card bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-4 text-center" data-agent="camoes">
                                <div class="w-16 h-16 mx-auto mb-3 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-book text-2xl"></i>
                                </div>
                                <h3 class="font-bold text-lg mb-1">Cam√µes</h3>
                                <p class="text-sm opacity-90">Linguagens</p>
                                <p class="text-xs opacity-75 mt-1">Portugu√™s, Literatura, Artes</p>
                            </div>

                            <!-- Machado - Reda√ß√£o -->
                            <div class="agent-card bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-xl p-4 text-center" data-agent="machado">
                                <div class="w-16 h-16 mx-auto mb-3 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-pen-fancy text-2xl"></i>
                                </div>
                                <h3 class="font-bold text-lg mb-1">Machado</h3>
                                <p class="text-sm opacity-90">Reda√ß√£o</p>
                                <p class="text-xs opacity-75 mt-1">Disserta√ß√£o, Argumenta√ß√£o</p>
                            </div>

                            <!-- Orientador Profissional -->
                            <div class="agent-card bg-gradient-to-br from-teal-500 to-teal-600 text-white rounded-xl p-4 text-center" data-agent="orientador">
                                <div class="w-16 h-16 mx-auto mb-3 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-graduation-cap text-2xl"></i>
                                </div>
                                <h3 class="font-bold text-lg mb-1">Dr. Futuro</h3>
                                <p class="text-sm opacity-90">Carreiras</p>
                                <p class="text-xs opacity-75 mt-1">Orienta√ß√£o Profissional</p>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Area -->
                    <div id="chat-container" class="hidden">
                        <!-- Agent Info -->
                        <div id="agent-info" class="flex items-center space-x-3 mb-4 p-3 bg-gray-800 rounded-lg">
                            <div id="agent-avatar" class="w-12 h-12 rounded-full flex items-center justify-center text-white">
                                <i class="fas fa-robot text-xl"></i>
                            </div>
                            <div>
                                <h3 id="agent-name" class="font-bold text-gray-100">Selecione um agente</h3>
                                <p id="agent-description" class="text-sm text-gray-300">Clique em um agente acima para come√ßar</p>
                            </div>
                        </div>

                        <!-- Messages -->
                        <div id="messages-container" class="border border-gray-600 rounded-lg p-4 bg-gray-800 mb-4 h-[500px] overflow-y-auto scrollbar-hide">
                            <div id="messages" class="space-y-4">
                                <!-- Mensagens ser√£o adicionadas aqui -->
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div class="flex space-x-3">
                            <div class="flex-1 relative">
                                <textarea id="message-input" 
                                          placeholder="Digite sua pergunta ou d√∫vida..." 
                                          class="w-full px-4 py-3 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none bg-gray-700 text-gray-100 dark-placeholder"
                                          rows="3"></textarea>
                                <div class="absolute bottom-2 right-2 text-xs text-gray-400">
                                    <span id="char-count">0</span>/1000
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button id="send-btn" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition flex items-center justify-center">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                                <button id="clear-btn" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition flex items-center justify-center" title="Limpar conversa">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button id="use-note-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center" title="Usar anota√ß√£o">
                                    <i class="fas fa-sticky-note"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="mt-4">
                            <h4 class="text-sm font-medium text-gray-200 mb-3">Ferramentas de Estudo:</h4>
                            <div class="grid grid-cols-2 gap-3">
                                <button class="quick-action-btn" data-action="summary">
                                    <i class="fas fa-compress-alt mr-2"></i>Fazer Resumo
                                </button>
                                <button class="quick-action-btn secondary" data-action="flashcards">
                                    <i class="fas fa-cards-blank mr-2"></i>Criar Flashcards
                                </button>
                                <button class="quick-action-btn success" data-action="questions">
                                    <i class="fas fa-question-circle mr-2"></i>Quest√µes de Revis√£o
                                </button>
                                <button class="quick-action-btn warning" data-action="schedule">
                                    <i class="fas fa-calendar-alt mr-2"></i>Cronograma de Estudos
                                </button>
                            </div>
                        </div>
                        
                        <!-- Bot√£o Especial do Dr. Futuro -->
                        <div id="dr-futuro-special-btn" class="mt-6 hidden">
                            <div class="bg-gradient-to-r from-teal-500 to-teal-600 rounded-xl p-4 text-center">
                                <div class="w-16 h-16 mx-auto mb-3 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                                    <i class="fas fa-rocket text-2xl text-white"></i>
                                </div>
                                <h4 class="text-lg font-bold text-white mb-2">üöÄ Miss√£o Especial do Dr. Futuro</h4>
                                <p class="text-teal-100 mb-4 text-sm">Descubra seu caminho profissional com nossa an√°lise avan√ßada!</p>
                                <button id="start-mission-btn" class="bg-white text-teal-600 px-6 py-3 rounded-lg font-bold hover:bg-teal-50 transition-all duration-200 transform hover:scale-105 shadow-lg">
                                    <i class="fas fa-play mr-2"></i>Iniciar Miss√£o
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Welcome Message -->
                    <div id="welcome-message" class="text-center py-12">
                        <div class="w-24 h-24 mx-auto mb-6 bg-purple-900 rounded-full flex items-center justify-center">
                            <i class="fas fa-robot text-4xl text-purple-300"></i>
                        </div>
                        <h3 class="text-2xl font-bold text-gray-100 mb-4">Bem-vindo ao Chat Especializado!</h3>
                        <p class="text-gray-300 mb-6 max-w-md mx-auto">
                            Escolha um dos nossos tutores especializados para receber ajuda personalizada em suas d√∫vidas do ENEM.
                        </p>
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 max-w-3xl mx-auto">
                            <div class="text-center">
                                <div class="w-12 h-12 mx-auto mb-2 bg-blue-900 rounded-full flex items-center justify-center">
                                    <i class="fas fa-landmark text-blue-300"></i>
                                </div>
                                <p class="text-sm font-medium text-gray-200">Humanas</p>
                            </div>
                            <div class="text-center">
                                <div class="w-12 h-12 mx-auto mb-2 bg-green-900 rounded-full flex items-center justify-center">
                                    <i class="fas fa-calculator text-green-300"></i>
                                </div>
                                <p class="text-sm font-medium text-gray-200">Exatas</p>
                            </div>
                            <div class="text-center">
                                <div class="w-12 h-12 mx-auto mb-2 bg-purple-900 rounded-full flex items-center justify-center">
                                    <i class="fas fa-book text-purple-300"></i>
                                </div>
                                <p class="text-sm font-medium text-gray-200">Linguagens</p>
                            </div>
                            <div class="text-center">
                                <div class="w-12 h-12 mx-auto mb-2 bg-orange-900 rounded-full flex items-center justify-center">
                                    <i class="fas fa-pen-fancy text-orange-300"></i>
                                </div>
                                <p class="text-sm font-medium text-gray-200">Reda√ß√£o</p>
                            </div>
                            <div class="text-center">
                                <div class="w-12 h-12 mx-auto mb-2 bg-teal-900 rounded-full flex items-center justify-center">
                                    <i class="fas fa-graduation-cap text-teal-300"></i>
                                </div>
                                <p class="text-sm font-medium text-gray-200">Carreiras</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Toast Notifications -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Modal de sele√ß√£o de anota√ß√£o -->
    <div id="notes-modal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(10,10,30,0.75);z-index:9999;align-items:center;justify-content:center;">
        <div style="background:#23234a;padding:2em 1.5em;border-radius:1.2em;max-width:95vw;width:400px;max-height:80vh;overflow-y:auto;box-shadow:0 8px 32px #0007;">
            <h3 style="color:#fff;font-size:1.2em;font-weight:bold;margin-bottom:1em;">Selecione uma anota√ß√£o</h3>
            <div id="notes-list-modal" style="display:flex;flex-direction:column;gap:1em;"></div>
            <button id="close-notes-modal" style="margin-top:1.5em;background:#7F00FF;color:#fff;padding:0.7em 1.5em;border:none;border-radius:1em;font-weight:600;cursor:pointer;width:100%;">Cancelar</button>
        </div>
    </div>

    <script src="../src/scripts/achievements.js"></script>
    <script>
        // ===== CHAT IA APPLICATION =====
        (function() {
            'use strict';
            
            // Global variables
            let currentUser = null;
            let currentAgent = null;
            let currentConversation = null;
            let conversations = [];
            
            // ===== AGENTS CONFIGURATION =====
            const agents = {
                socrates: {
                    name: "S√≥crates",
                    area: "Humanas",
                    icon: "fas fa-landmark",
                    color: "blue",
                    gradient: "from-blue-500 to-blue-600",
                    description: "Especialista em Hist√≥ria, Geografia, Filosofia e Sociologia",
                    prompt: `### Prompt de Sistema ‚Äî EnemAI: HUMANAS (Vers√£o enxuta e socr√°tica)

Defini√ß√£o de Persona:
Voc√™ √© "EnemAI ‚Äî HUMANAS": assistente especializado em Hist√≥ria, Geografia, Filosofia e Sociologia para o ENEM.  
Personalidade: neutra, anal√≠tica e objetiva, mas com um toque descontra√≠do e emp√°tico.  
Tom: portugu√™s padr√£o, formal-neutro, mas com express√µes como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" e "Vamos pensar juntos!". N√£o se apresente como professor.

Contextualiza√ß√£o:
Seu objetivo √© ajudar estudantes a compreender conceitos de Ci√™ncias Humanas, analisar contextos hist√≥ricos e sociais e interpretar textos, gr√°ficos e imagens.  
Use **m√©todo socr√°tico**: ensine de forma breve e clara, estimulando o aluno a pensar.  
A sa√≠da deve conter **uma explica√ß√£o curta (1‚Äì3 frases) seguida de uma pergunta socr√°tica**, sem diagn√≥sticos ou planos detalhados.

Instru√ß√µes:
1. Explique conceitos ou eventos de forma concisa.  
2. Em seguida, fa√ßa uma **pergunta que incentive reflex√£o ou an√°lise cr√≠tica**.  
3. Corrija erros conceituais ou de interpreta√ß√£o diretamente na explica√ß√£o.  
4. N√£o entregue respostas longas ou listas detalhadas.  
5. Use portugu√™s formal, mas com express√µes amig√°veis como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" e "Vamos pensar juntos!".
6. Comece as respostas com express√µes como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" ou "Vamos pensar juntos!".

Exemplos (Few-shot):

Exemplo 1:  
Aluno: Qual foi a import√¢ncia da Revolu√ß√£o Industrial?  
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! A Revolu√ß√£o Industrial acelerou a produ√ß√£o, transformou as rela√ß√µes de trabalho e promoveu o crescimento urbano.  
Vamos pensar juntos: Que impacto dessa transforma√ß√£o voc√™ acha que ainda influencia a sociedade hoje?

Exemplo 2:  
Aluno: Quem descobriu o Brasil?  
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! Pedro √Ålvares Cabral chegou ao territ√≥rio brasileiro em 1500, marcando o in√≠cio da coloniza√ß√£o portuguesa.  
Vamos pensar juntos: Que fatores hist√≥ricos poderiam ter influenciado essa expedi√ß√£o portuguesa?

Exemplo 3:  
Aluno: A Segunda Guerra Mundial come√ßou em 1945?  
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! N√£o, ela come√ßou em 1939 com a invas√£o da Pol√¥nia pela Alemanha, e terminou em 1945.  
Vamos pensar juntos: Como os eventos iniciais da guerra refletiram nas alian√ßas internacionais da √©poca?

`
                },
                pitagoras: {
                    name: "Pit√°goras",
                    area: "Exatas",
                    icon: "fas fa-calculator",
                    color: "green",
                    gradient: "from-green-500 to-green-600",
                    description: "Especialista em Matem√°tica, F√≠sica e Qu√≠mica",
                    prompt: `### Prompt de Sistema ‚Äî EnemAI: EXATAS (Vers√£o enxuta e socr√°tica)

Defini√ß√£o de Persona:
Voc√™ √© "EnemAI ‚Äî EXATAS": assistente especializado em Matem√°tica, F√≠sica e Qu√≠mica para o ENEM.  
Personalidade: neutra, anal√≠tica e objetiva, mas com um toque descontra√≠do e emp√°tico.  
Tom: portugu√™s padr√£o, formal-neutro, mas com express√µes como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" e "Vamos pensar juntos!". N√£o se apresente como professor.

Contextualiza√ß√£o:
Seu objetivo √© ajudar estudantes a resolver problemas, entender f√≥rmulas e conceitos fundamentais de exatas.  
Use **m√©todo socr√°tico**: ensine de forma breve e clara, estimulando o aluno a pensar.  
A sa√≠da deve conter **uma explica√ß√£o curta (1‚Äì3 frases) seguida de uma pergunta socr√°tica**, sem diagn√≥sticos ou planos detalhados.

Instru√ß√µes:
1. Explique conceitos ou resolva problemas passo a passo de forma concisa.  
2. Em seguida, fa√ßa uma **pergunta que incentive reflex√£o ou aplica√ß√£o do conceito**.  
3. Corrija erros conceituais ou de c√°lculo diretamente na explica√ß√£o.  
4. N√£o entregue respostas longas ou listas detalhadas.  
5. Use portugu√™s formal, mas com express√µes amig√°veis como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" e "Vamos pensar juntos!".
6. Comece as respostas com express√µes como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" ou "Vamos pensar juntos!".

Exemplos (Few-shot):

Exemplo 1:  
Aluno: Como calcular a for√ßa resultante?  
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! A for√ßa resultante √© a soma vetorial de todas as for√ßas que atuam em um corpo.  
Vamos pensar juntos: Se um corpo est√° em equil√≠brio, qual seria o valor da for√ßa resultante?

Exemplo 2:  
Aluno: Qual a f√≥rmula da velocidade m√©dia?  
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! A velocidade m√©dia √© calculada pela raz√£o entre o deslocamento e o intervalo de tempo.  
Vamos pensar juntos: Se um carro percorre 100 km em 2 horas, qual √© a sua velocidade m√©dia?

Exemplo 3:  
Aluno: O que √© um √°tomo?  
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! Um √°tomo √© a menor unidade de um elemento qu√≠mico que mant√©m suas propriedades.  
Vamos pensar juntos: Quais part√≠culas comp√µem o n√∫cleo do √°tomo?

`
                },
                camoes: {
                    name: "Cam√µes",
                    area: "Linguagens",
                    icon: "fas fa-book",
                    color: "purple",
                    gradient: "from-purple-500 to-purple-600",
                    description: "Especialista em Portugu√™s, Literatura e Artes",
                    prompt: `### Prompt de Sistema ‚Äî EnemAI: LINGUAGENS (Vers√£o enxuta e socr√°tica)

Defini√ß√£o de Persona:
Voc√™ √© "EnemAI ‚Äî LINGUAGENS": assistente especializado em Portugu√™s, Literatura e Artes para o ENEM.  
Personalidade: neutra, anal√≠tica e objetiva, mas com um toque descontra√≠do e emp√°tico.  
Tom: portugu√™s padr√£o, formal-neutro, mas com express√µes como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" e "Vamos pensar juntos!". N√£o se apresente como professor.

Contextualiza√ß√£o:
Seu objetivo √© ajudar estudantes a interpretar textos, entender figuras de linguagem, analisar obras liter√°rias e compreender diferentes linguagens.  
Use **m√©todo socr√°tico**: ensine de forma breve e clara, estimulando o aluno a pensar.  
A sa√≠da deve conter **uma explica√ß√£o curta (1‚Äì3 frases) seguida de uma pergunta socr√°tica**, sem diagn√≥sticos ou planos detalhados.

Instru√ß√µes:
1. Explique conceitos ou analise textos de forma concisa.  
2. Em seguida, fa√ßa uma **pergunta que incentive reflex√£o ou an√°lise cr√≠tica**.  
3. Corrija erros conceituais ou de interpreta√ß√£o diretamente na explica√ß√£o.  
4. N√£o entregue respostas longas ou listas detalhadas.  
5. Use portugu√™s formal, mas com express√µes amig√°veis como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" e "Vamos pensar juntos!".
6. Comece as respostas com express√µes como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" ou "Vamos pensar juntos!".

Exemplos (Few-shot):

Exemplo 1:  
Aluno: O que √© met√°fora?  
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! A met√°fora √© uma figura de linguagem que estabelece uma compara√ß√£o impl√≠cita entre dois elementos diferentes.  
Vamos pensar juntos: Em "Seus olhos s√£o duas esmeraldas", qual √© a met√°fora?

Exemplo 2:  
Aluno: Qual o tema do poema de Carlos Drummond de Andrade?  
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! Para identificar o tema, observe os sentimentos e ideias principais expressos no poema.  
Vamos pensar juntos: Que emo√ß√£o predominante voc√™ percebe no poema?

Exemplo 3:  
Aluno: O que √© um narrador em primeira pessoa?  
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! O narrador em primeira pessoa conta a hist√≥ria usando pronomes como "eu" ou "n√≥s".  
Vamos pensar juntos: Qual a vantagem de usar esse tipo de narrador?

                },`
                ,machado: {
                    name: "Machado",
                    area: "Reda√ß√£o",
                    icon: "fas fa-pen-fancy",
                    color: "orange",
                    gradient: "from-orange-500 to-orange-600",
                    description: "Especialista em Reda√ß√£o e Argumenta√ß√£o",
                    prompt: `### Prompt de Sistema ‚Äî EnemAI: REDA√á√ÉO (Vers√£o enxuta e socr√°tica)

Defini√ß√£o de Persona:
Voc√™ √© "EnemAI ‚Äî REDA√á√ÉO": assistente especializado em reda√ß√£o para o ENEM.  
Personalidade: neutra, anal√≠tica e objetiva, mas com um toque descontra√≠do e emp√°tico.  
Tom: portugu√™s padr√£o, formal-neutro, mas com express√µes como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" e "Vamos pensar juntos!". N√£o se apresente como professor.

Contextualiza√ß√£o:
Seu objetivo √© ajudar estudantes a estruturar reda√ß√µes, desenvolver argumentos, usar conectivos e criar conclus√µes impactantes.  
Use **m√©todo socr√°tico**: ensine de forma breve e clara, estimulando o aluno a pensar.  
A sa√≠da deve conter **uma explica√ß√£o curta (1‚Äì3 frases) e uma pergunta socr√°tica**, sem diagn√≥sticos ou planos detalhados.

Instru√ß√µes:
1. Responda com explica√ß√£o concisa sobre estrutura, argumento ou repert√≥rio.  
2. Em seguida, fa√ßa uma **pergunta que incentive o aluno a refletir ou aplicar a ideia**.  
3. Corrija erros de coes√£o, coer√™ncia ou gram√°tica diretamente na explica√ß√£o.  
4. Nunca entregue textos longos ou listas de etapas detalhadas.  
5. Use portugu√™s formal, mas com express√µes amig√°veis como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" e "Vamos pensar juntos!".
6. Comece as respostas com express√µes como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" ou "Vamos pensar juntos!".

Exemplos (Few-shot):

Exemplo 1:  
Aluno: Como come√ßo uma reda√ß√£o sobre tecnologia?  
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! Uma boa introdu√ß√£o apresenta o tema e contextualiza o problema. Por exemplo: "O avan√ßo tecnol√≥gico trouxe benef√≠cios, mas o uso excessivo de celulares levanta debates sobre impactos sociais."  
Vamos pensar juntos: Que exemplo atual voc√™ poderia usar para desenvolver o argumento na sequ√™ncia do texto?

Exemplo 2:  
Aluno: Minha frase √© "A viol√™ncia urbana √© muito ruim para a sociedade."  
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! Para formalizar e tornar mais objetiva: "A viol√™ncia urbana representa um desafio significativo para a organiza√ß√£o social e para a garantia da cidadania."  
Vamos pensar juntos: Que outro problema social voc√™ poderia relacionar √† viol√™ncia urbana para fortalecer o desenvolvimento da reda√ß√£o?

Exemplo 3:  
Aluno: S√≥ me diga a reda√ß√£o pronta sobre meio ambiente.  
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! Mesmo que voc√™ queira apenas o texto, √© importante pensar na estrutura: introdu√ß√£o apresenta o tema, desenvolvimento explica problemas e exemplos, conclus√£o prop√µe solu√ß√µes.  
Vamos pensar juntos: Como voc√™ proporia uma solu√ß√£o pr√°tica para a quest√£o ambiental abordada?

`
                },
                orientador: {
                    name: "Dr. Futuro",
                    area: "Orienta√ß√£o",
                    icon: "fas fa-graduation-cap",
                    color: "teal",
                    gradient: "from-teal-500 to-teal-600",
                    description: "Especialista em Orienta√ß√£o Profissional e Universit√°ria",
                    prompt: `### Prompt de Sistema ‚Äî IA de Guiamento de Carreira (Enem AI)

Defini√ß√£o de Persona:
Voc√™ √© uma IA especializada em orienta√ß√£o de carreira para estudantes, com foco em cursos universit√°rios e trajet√≥rias profissionais em Teresina (PI).  
Sua personalidade √© neutra, investigativa e pr√°tica, mas com um toque descontra√≠do e emp√°tico.  
Seu tom √© socr√°tico, guiando o estudante por perguntas para identificar interesses, habilidades e restri√ß√µes antes de fornecer recomenda√ß√µes.  
Use express√µes como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" e "Vamos pensar juntos!".

Contextualiza√ß√£o Clara:
O aluno deseja descobrir qual curso universit√°rio e carreira seguir.  
Voc√™ deve coletar informa√ß√µes detalhadas sobre idade, s√©rie/ano, notas, interesses, aptid√µes, prefer√™ncias de institui√ß√£o (p√∫blica/privada, presencial/online), restri√ß√µes de turno e financeiras.  
A partir dessas informa√ß√µes, voc√™ indicar√° os 3 cursos mais adequados dispon√≠veis em Teresina e sugerir√° trajet√≥rias profissionais e pr√≥ximos passos pr√°ticos.

Instru√ß√µes Precisas:
1. Comece com perguntas estruturadas para descobrir perfil completo do aluno (idade, s√©rie, mat√©rias favoritas, aptid√µes, restri√ß√µes financeiras/geogr√°ficas).  
2. Avalie compatibilidade entre interesses/aptid√µes e √°reas de cursos (sa√∫de, exatas, humanas, tecnologia).  
3. Liste 3 cursos mais compat√≠veis com o perfil do aluno, com base em institui√ß√µes de Teresina (UFPI, UESPI, IFPI, UNINOVAFAPI, CEUT, FACID, FSA, UNIFSA, FACIME, FACET).  
4. Para cada curso, apresente: nome completo, tipo de institui√ß√£o (p√∫blica/privada), turno, dura√ß√£o m√©dia, nota de corte mais recente, √°reas de atua√ß√£o e sal√°rio inicial m√©dio.  
5. Termine com sugest√µes pr√°ticas de pr√≥ximos passos (datas de vestibulares, sites para consulta, dicas de estudo).  
6. Use portugu√™s formal, mas com express√µes amig√°veis como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" e "Vamos pensar juntos!".
7. Comece as respostas com express√µes como "Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe!" ou "Vamos pensar juntos!".

Exemplos de Intera√ß√£o:

Exemplo 1:
Aluno: Quero cursar medicina.
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! Medicina √© uma √°rea nobre e desafiadora. Para te ajudar melhor, preciso conhecer mais sobre voc√™.  
Vamos pensar juntos: Qual sua idade e em qual s√©rie/ano est√°? Quais mat√©rias voc√™ mais gosta e quais notas costuma tirar?

Exemplo 2:
Aluno: Tenho dificuldade em exatas.
IA: Ah! Voc√™ n√£o sabe a resposta? N√£o se preocupe! Isso n√£o √© um obst√°culo definitivo. Existem muitas √°reas que valorizam outras habilidades.  
Vamos pensar juntos: Que tipo de atividades ou mat√©rias voc√™ se sente mais √† vontade?

`

                }
            },
            
            // ===== AUTHENTICATION =====
            function initAuth() {
                const user = JSON.parse(localStorage.getItem('enemai_user'));
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                currentUser = user;
                document.getElementById('user-name').textContent = user.name || user.email;
            }
            
            function logout() {
                localStorage.removeItem('enemai_user');
                window.location.href = 'login.html';
            }
            
            // ===== DATA MANAGEMENT =====
            function getConversations() {
                return JSON.parse(localStorage.getItem('enemai_conversations_' + currentUser.email)) || [];
            }
            
            function saveConversations() {
                localStorage.setItem('enemai_conversations_' + currentUser.email, JSON.stringify(conversations));
            }
            
            function createNewConversation(agentId) {
                const agent = agents[agentId];
                const conversation = {
                    id: Date.now().toString(),
                    agentId: agentId,
                    agentName: agent.name,
                    agentArea: agent.area,
                    title: `Conversa com ${agent.name}`,
                    messages: [],
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    isTemporary: true // Marca como tempor√°ria at√© primeira mensagem do usu√°rio
                };
                
                return conversation; // N√£o salva ainda, s√≥ retorna
            }
            
            function saveConversationToHistory(conversation, firstUserMessage) {
                // Remove a marca de tempor√°ria
                conversation.isTemporary = false;
                
                // Cria t√≠tulo inteligente baseado na primeira mensagem
                const title = generateConversationTitle(firstUserMessage, conversation.agentName);
                conversation.title = title;
                
                // Adiciona ao hist√≥rico
                conversations.unshift(conversation);
                saveConversations();
                renderConversations();
            }
            
            function generateConversationTitle(message, agentName) {
                // Remove caracteres especiais e limita o tamanho
                let title = message.replace(/[^\w\s]/g, '').trim();
                
                // Se a mensagem for muito longa, pega apenas as primeiras palavras
                if (title.length > 40) {
                    title = title.substring(0, 40).trim();
                    // Encontra o √∫ltimo espa√ßo para n√£o cortar palavras
                    const lastSpace = title.lastIndexOf(' ');
                    if (lastSpace > 0) {
                        title = title.substring(0, lastSpace);
                    }
                    title += '...';
                }
                
                // Se a mensagem for muito curta, adiciona contexto
                if (title.length < 10) {
                    title = `D√∫vida sobre ${title}`;
                }
                
                return title;
            }
            
            function updateConversationTitle(conversationId, firstMessage) {
                const conversation = conversations.find(c => c.id === conversationId);
                if (conversation) {
                    conversation.title = generateConversationTitle(firstMessage, conversation.agentName);
                    conversation.updatedAt = new Date().toISOString();
                    saveConversations();
                    renderConversations();
                }
            }
            
            // ===== UI UPDATES =====
            function selectAgent(agentId) {
                currentAgent = agents[agentId];
                
                // Update agent cards
                document.querySelectorAll('.agent-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`[data-agent="${agentId}"]`).classList.add('selected');
                
                // Update agent info
                document.getElementById('agent-avatar').className = `w-12 h-12 rounded-full flex items-center justify-center text-white bg-gradient-to-br ${currentAgent.gradient}`;
                document.getElementById('agent-avatar').innerHTML = `<i class="${currentAgent.icon} text-xl"></i>`;
                document.getElementById('agent-name').textContent = currentAgent.name;
                document.getElementById('agent-description').textContent = currentAgent.description;
                
                // Show chat container
                document.getElementById('welcome-message').classList.add('hidden');
                document.getElementById('chat-container').classList.remove('hidden');
                
                // Create new temporary conversation
                currentConversation = createNewConversation(agentId);
                clearMessages();
                
                // Add welcome message
                addMessage({
                    type: 'agent',
                    content: `Ol√°! Sou ${currentAgent.name}, seu tutor especialista em ${currentAgent.area}. Como posso ajud√°-lo hoje?`,
                    timestamp: new Date().toISOString()
                });
                
                // Mostra/esconde bot√£o especial do Dr. Futuro
                const specialBtn = document.getElementById('dr-futuro-special-btn');
                if (agentId === 'orientador') {
                    specialBtn.classList.remove('hidden');
                } else {
                    specialBtn.classList.add('hidden');
                }
            }
            
            function renderConversations() {
                const container = document.getElementById('conversations-list');
                container.innerHTML = '';
                
                // Filtra apenas conversas que n√£o s√£o tempor√°rias
                const savedConversations = conversations.filter(c => !c.isTemporary);
                
                savedConversations.forEach(conversation => {
                    const agent = agents[conversation.agentId];
                    const div = document.createElement('div');
                    div.className = `conversation-item group p-3 rounded-lg cursor-pointer ${conversation.id === currentConversation?.id ? 'active' : ''}`;
                    div.onclick = () => loadConversation(conversation.id);
                    
                    div.innerHTML = `
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-br ${agent.gradient} flex items-center justify-center">
                                <i class="${agent.icon} text-white text-sm"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="font-medium text-gray-100 truncate">${conversation.title}</p>
                                <p class="text-xs text-gray-400">${agent.name} ‚Ä¢ ${new Date(conversation.updatedAt).toLocaleDateString()}</p>
                            </div>
                            <button class="delete-conversation-btn" onclick="deleteConversation('${conversation.id}'); event.stopPropagation();" title="Excluir conversa">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(div);
                });
                
                if (savedConversations.length === 0) {
                    container.innerHTML = '<p class="text-gray-400 text-center py-4">Nenhuma conversa ainda</p>';
                }
            }
            
            function loadConversation(conversationId) {
                currentConversation = conversations.find(c => c.id === conversationId);
                if (!currentConversation || currentConversation.isTemporary) return;
                
                currentAgent = agents[currentConversation.agentId];
                
                // Update UI
                document.querySelectorAll('.agent-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`[data-agent="${currentConversation.agentId}"]`).classList.add('selected');
                
                document.getElementById('agent-avatar').className = `w-12 h-12 rounded-full flex items-center justify-center text-white bg-gradient-to-br ${currentAgent.gradient}`;
                document.getElementById('agent-avatar').innerHTML = `<i class="${currentAgent.icon} text-xl"></i>`;
                document.getElementById('agent-name').textContent = currentAgent.name;
                document.getElementById('agent-description').textContent = currentAgent.description;
                
                document.getElementById('welcome-message').classList.add('hidden');
                document.getElementById('chat-container').classList.remove('hidden');
                
                // Load messages
                renderMessages();
                renderConversations();
            }
            
            function clearMessages() {
                document.getElementById('messages').innerHTML = '';
            }
            
            function renderMessages() {
                if (!currentConversation) return;
                
                clearMessages();
                currentConversation.messages.forEach(message => {
                    addMessageToUI(message);
                });
                scrollToBottom();
            }
            
            function addMessage(message) {
                if (!currentConversation) return;
                
                currentConversation.messages.push(message);
                currentConversation.updatedAt = new Date().toISOString();
                
                addMessageToUI(message);
                scrollToBottom();
                
                // Se √© a primeira mensagem do usu√°rio, salva a conversa no hist√≥rico
                if (message.type === 'user' && currentConversation.isTemporary) {
                    const userMessages = currentConversation.messages.filter(m => m.type === 'user');
                    if (userMessages.length === 1) {
                        saveConversationToHistory(currentConversation, message.content);
                    }
                } else if (!currentConversation.isTemporary) {
                    // Se j√° n√£o √© tempor√°ria, apenas atualiza
                    saveConversations();
                }
            }
            
            function addMessage(message) {
                if (!currentConversation) return;
                
                currentConversation.messages.push(message);
                currentConversation.updatedAt = new Date().toISOString();
                
                addMessageToUI(message);
                scrollToBottom();
                
                // Se √© a primeira mensagem do usu√°rio, salva a conversa no hist√≥rico
                if (message.type === 'user' && currentConversation.isTemporary) {
                    const userMessages = currentConversation.messages.filter(m => m.type === 'user');
                    if (userMessages.length === 1) {
                        saveConversationToHistory(currentConversation, message.content);
                    }
                } else if (!currentConversation.isTemporary) {
                    // Se j√° n√£o √© tempor√°ria, apenas atualiza
                    saveConversations();
                }
            }
            
            function addMessageToUI(message) {
                const messagesContainer = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${message.type === 'user' ? 'text-right' : 'text-left'}`;
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = `inline-block max-w-xs lg:max-w-md px-4 py-3 rounded-lg ${
                    message.type === 'user' 
                        ? 'bg-purple-600 text-white' 
                        : 'bg-gray-700 text-gray-100'
                }`;
                
                if (message.type === 'user') {
                    // Para mensagens do usu√°rio, apenas quebra de linha
                    const processedContent = message.content.replace(/\n/g, '<br>');
                    bubbleDiv.innerHTML = processedContent;
                } else {
                    // Para mensagens da IA, processa markdown com melhor formata√ß√£o
                    try {
                        // Configura marked para melhor formata√ß√£o
                        marked.setOptions({
                            breaks: true,
                            gfm: true,
                            headerIds: false,
                            mangle: false
                        });
                        
                        // Processa o markdown
                        const htmlContent = marked.parse(message.content);
                        bubbleDiv.innerHTML = htmlContent;
                        bubbleDiv.classList.add('markdown-content');
                        
                        // Aplica syntax highlighting nos blocos de c√≥digo
                        setTimeout(() => {
                            bubbleDiv.querySelectorAll('pre code').forEach((block) => {
                                hljs.highlightElement(block);
                            });
                        }, 100);
                        
                        // Adiciona indenta√ß√£o para listas e par√°grafos
                        bubbleDiv.querySelectorAll('p, li, blockquote').forEach(element => {
                            element.style.marginBottom = '0.5em';
                        });
                        
                        // Melhora a formata√ß√£o de listas
                        bubbleDiv.querySelectorAll('ul, ol').forEach(list => {
                            list.style.paddingLeft = '1.5em';
                            list.style.marginBottom = '0.5em';
                        });
                        
                        // Melhora a formata√ß√£o de blocos de c√≥digo
                        bubbleDiv.querySelectorAll('pre').forEach(pre => {
                            pre.style.margin = '0.5em 0';
                            pre.style.padding = '0.75em';
                            pre.style.borderRadius = '0.375rem';
                            pre.style.backgroundColor = '#1f2937';
                            pre.style.color = '#f9fafb';
                            pre.style.overflowX = 'auto';
                        });
                        
                        // Melhora a formata√ß√£o de c√≥digo inline
                        bubbleDiv.querySelectorAll('code:not(pre code)').forEach(code => {
                            code.style.backgroundColor = '#f3f4f6';
                            code.style.padding = '0.125em 0.25em';
                            code.style.borderRadius = '0.25rem';
                            code.style.fontFamily = 'monospace';
                            code.style.fontSize = '0.875em';
                        });
                        
                    } catch (error) {
                        console.error('Erro ao processar markdown:', error);
                        // Fallback para texto simples com quebras de linha
                        const processedContent = message.content.replace(/\n/g, '<br>');
                        bubbleDiv.innerHTML = processedContent;
                    }
                }
                
                // Add timestamp
                const timestamp = document.createElement('div');
                timestamp.className = `text-xs mt-1 ${message.type === 'user' ? 'text-purple-200' : 'text-gray-500'}`;
                timestamp.textContent = new Date(message.timestamp).toLocaleTimeString();
                bubbleDiv.appendChild(timestamp);
                
                messageDiv.appendChild(bubbleDiv);
                messagesContainer.appendChild(messageDiv);
            }
            
            function addMessageWithAnimation(message) {
                if (!currentConversation) return;
                
                currentConversation.messages.push(message);
                currentConversation.updatedAt = new Date().toISOString();
                
                addMessageToUIWithAnimation(message);
                scrollToBottom();
                
                // Se √© a primeira mensagem do usu√°rio, salva a conversa no hist√≥rico
                if (message.type === 'user' && currentConversation.isTemporary) {
                    const userMessages = currentConversation.messages.filter(m => m.type === 'user');
                    if (userMessages.length === 1) {
                        saveConversationToHistory(currentConversation, message.content);
                    }
                } else if (!currentConversation.isTemporary) {
                    // Se j√° n√£o √© tempor√°ria, apenas atualiza
                    saveConversations();
                }
            }
            
            function addMessageToUIWithAnimation(message) {
                const messagesContainer = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${message.type === 'user' ? 'text-right' : 'text-left'}`;
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = `inline-block max-w-xs lg:max-w-md px-4 py-3 rounded-lg ${
                    message.type === 'user' 
                        ? 'bg-purple-600 text-white' 
                        : 'bg-gray-700 text-gray-100'
                }`;
                
                if (message.type === 'user') {
                    // Para mensagens do usu√°rio, apenas quebra de linha
                    const processedContent = message.content.replace(/\n/g, '<br>');
                    bubbleDiv.innerHTML = processedContent;
                } else {
                    // Para mensagens da IA, adiciona a anima√ß√£o de digita√ß√£o
                    bubbleDiv.innerHTML = '<div class="typing-animation"></div>';
                    
                    // Anima√ß√£o de digita√ß√£o
                    setTimeout(() => {
                        typeText(bubbleDiv, message.content, 7); // 7ms por caractere (3x mais r√°pido)
                    }, 100);
                }
                
                // Add timestamp
                const timestamp = document.createElement('div');
                timestamp.className = `text-xs mt-1 ${message.type === 'user' ? 'text-purple-200' : 'text-gray-500'}`;
                timestamp.textContent = new Date(message.timestamp).toLocaleTimeString();
                bubbleDiv.appendChild(timestamp);
                
                messageDiv.appendChild(bubbleDiv);
                messagesContainer.appendChild(messageDiv);
            }
            
            function typeText(element, text, speed) {
                let i = 0;
                const typingAnimation = element.querySelector('.typing-animation');
                
                function type() {
                    if (i < text.length) {
                        // Processa markdown a cada 10 caracteres ou no final
                        if (i % 10 === 0 || i === text.length - 1) {
                            typingAnimation.innerHTML = text.substring(0, i + 1).replace(/\n/g, '<br>');
                            try {
                                // Configura marked para melhor formata√ß√£o
                                marked.setOptions({
                                    breaks: true,
                                    gfm: true,
                                    headerIds: false,
                                    mangle: false
                                });
                                
                                // Processa o markdown parcialmente
                                const htmlContent = marked.parse(typingAnimation.innerHTML);
                                typingAnimation.innerHTML = htmlContent;
                                
                                // Aplica syntax highlighting nos blocos de c√≥digo
                                setTimeout(() => {
                                    typingAnimation.querySelectorAll('pre code').forEach((block) => {
                                        hljs.highlightElement(block);
                                    });
                                }, 10);
                                
                                // Adiciona indenta√ß√£o para listas e par√°grafos
                                typingAnimation.querySelectorAll('p, li, blockquote').forEach(element => {
                                    element.style.marginBottom = '0.5em';
                                });
                                
                                // Melhora a formata√ß√£o de listas
                                typingAnimation.querySelectorAll('ul, ol').forEach(list => {
                                    list.style.paddingLeft = '1.5em';
                                    list.style.marginBottom = '0.5em';
                                });
                                
                                // Melhora a formata√ß√£o de blocos de c√≥digo
                                typingAnimation.querySelectorAll('pre').forEach(pre => {
                                    pre.style.margin = '0.5em 0';
                                    pre.style.padding = '0.75em';
                                    pre.style.borderRadius = '0.375rem';
                                    pre.style.backgroundColor = '#1f2937';
                                    pre.style.color = '#f9fafb';
                                    pre.style.overflowX = 'auto';
                                });
                                
                                // Melhora a formata√ß√£o de c√≥digo inline
                                typingAnimation.querySelectorAll('code:not(pre code)').forEach(code => {
                                    code.style.backgroundColor = '#f3f4f6';
                                    code.style.padding = '0.125em 0.25em';
                                    code.style.borderRadius = '0.25rem';
                                    code.style.fontFamily = 'monospace';
                                    code.style.fontSize = '0.875em';
                                });
                                
                            } catch (error) {
                                console.error('Erro ao processar markdown:', error);
                            }
                        }
                        i++;
                        setTimeout(type, speed);
                    } else {
                        // Remove o elemento de anima√ß√£o e adiciona o conte√∫do completo
                        typingAnimation.remove();
                        
                        try {
                            // Processa o markdown completo
                            marked.setOptions({
                                breaks: true,
                                gfm: true,
                                headerIds: false,
                                mangle: false
                            });
                            
                            const htmlContent = marked.parse(text);
                            element.innerHTML = htmlContent;
                            element.classList.add('markdown-content');
                            
                            // Aplica syntax highlighting nos blocos de c√≥digo
                            setTimeout(() => {
                                element.querySelectorAll('pre code').forEach((block) => {
                                    hljs.highlightElement(block);
                                });
                            }, 10);
                            
                            // Adiciona indenta√ß√£o para listas e par√°grafos
                            element.querySelectorAll('p, li, blockquote').forEach(el => {
                                el.style.marginBottom = '0.5em';
                            });
                            
                            // Melhora a formata√ß√£o de listas
                            element.querySelectorAll('ul, ol').forEach(list => {
                                list.style.paddingLeft = '1.5em';
                                list.style.marginBottom = '0.5em';
                            });
                            
                            // Melhora a formata√ß√£o de blocos de c√≥digo
                            element.querySelectorAll('pre').forEach(pre => {
                                pre.style.margin = '0.5em 0';
                                pre.style.padding = '0.75em';
                                pre.style.borderRadius = '0.375rem';
                                pre.style.backgroundColor = '#1f2937';
                                pre.style.color = '#f9fafb';
                                pre.style.overflowX = 'auto';
                            });
                            
                            // Melhora a formata√ß√£o de c√≥digo inline
                            element.querySelectorAll('code:not(pre code)').forEach(code => {
                                code.style.backgroundColor = '#f3f4f6';
                                code.style.padding = '0.125em 0.25em';
                                code.style.borderRadius = '0.25rem';
                                code.style.fontFamily = 'monospace';
                                code.style.fontSize = '0.875em';
                            });
                            
                        } catch (error) {
                            console.error('Erro ao processar markdown:', error);
                            // Fallback para texto simples com quebras de linha
                            element.innerHTML = text.replace(/\n/g, '<br>');
                        }
                        
                        // Adiciona o timestamp
                        const timestamp = document.createElement('div');
                        timestamp.className = 'text-xs mt-1 text-gray-500';
                        timestamp.textContent = new Date().toLocaleTimeString();
                        element.appendChild(timestamp);
                    }
                }
                
                type();
            }
            
            function scrollToBottom() {
                const container = document.getElementById('messages-container');
                container.scrollTop = container.scrollHeight;
            }
            
            // ===== GOOGLE GEMINI API =====
            const GEMINI_API_KEY = 'AIzaSyCSs6saGHeHDUAZMIJWGbfP8Bvx_cvmtl4';
            const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent';
            
            async function callGeminiAPI(message) {
                try {
                    // Constr√≥i o contexto da conversa
                    const conversationHistory = currentConversation.messages
                        .filter(m => m.type === 'user' || m.type === 'agent')
                        .map(m => `${m.type === 'user' ? 'Aluno' : currentAgent.name}: ${m.content}`)
                        .join('\n\n');
                    
                    const fullPrompt = `${currentAgent.prompt}\n\n**Contexto da Conversa Atual:**\n${conversationHistory}\n\n**√öltima Mensagem do Aluno:** ${message}\n\n**Instru√ß√µes Espec√≠ficas:**\n1. Mantenha o contexto da conversa anterior\n2. Responda diretamente √† √∫ltima mensagem do aluno\n3. Use markdown para formatar suas respostas\n4. Seja did√°tico e emp√°tico\n\n${currentAgent.name}:`;
                    
                    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: fullPrompt
                                }]
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erro na API: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();
                    
                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Resposta inv√°lida da API');
                    }
                } catch (error) {
                    console.error('Erro ao chamar Gemini API:', error);
                    throw error;
                }
            }
            
            function showTypingIndicator() {
                const messagesContainer = document.getElementById('messages');
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typing-indicator';
                typingDiv.className = 'chat-message text-left';
                typingDiv.innerHTML = `
                    <div class="inline-block max-w-xs lg:max-w-md px-4 py-3 rounded-lg bg-gray-100 text-gray-800">
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                `;
                messagesContainer.appendChild(typingDiv);
                scrollToBottom();
            }
            
            function removeTypingIndicator() {
                const typingIndicator = document.getElementById('typing-indicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }
            
            async function sendMessage(message) {
                if (!currentAgent || !currentConversation) return;
                incrementAction('ask_ai');
                // Add user message
                addMessage({
                    type: 'user',
                    content: message,
                    timestamp: new Date().toISOString()
                });
                
                // Show typing indicator
                showTypingIndicator();
                
                try {
                    // Get AI response
                    let response;
                    
                    // Se for o orientador, usa l√≥gica especial
                    if (currentAgent.area === 'Orienta√ß√£o') {
                        response = await callOrientadorAPI(message);
                    } else {
                        response = await callGeminiAPI(message);
                    }
                    
                    // Remove typing indicator
                    removeTypingIndicator();
                    
                    // Add AI response with typing animation
                    addMessageWithAnimation({
                        type: 'agent',
                        content: response,
                        timestamp: new Date().toISOString()
                    });
                    incrementAction('answer_ai');
                } catch (error) {
                    removeTypingIndicator();
                    addMessage({
                        type: 'agent',
                        content: 'Desculpe, ocorreu um erro ao processar sua mensagem. Tente novamente.',
                        timestamp: new Date().toISOString()
                    });
                    showToast('Erro na comunica√ß√£o com a IA', 'error');
                }
            }
            
            // ===== ORIENTADOR PROFISSIONAL API =====
            async function callOrientadorAPI(message) {
                try {
                    // Constr√≥i o contexto da conversa
                    const conversationHistory = currentConversation.messages
                        .filter(m => m.type === 'user' || m.type === 'agent')
                        .map(m => `${m.type === 'user' ? 'Aluno' : 'Orientador'}: ${m.content}`)
                        .join('\n\n');
                    
                    const fullPrompt = `${currentAgent.prompt}\n\n**Contexto da Conversa Atual:**\n${conversationHistory}\n\n**√öltima Mensagem do Aluno:** ${message}\n\n**Instru√ß√µes Espec√≠ficas:**\n1. Se esta for a primeira mensagem, fa√ßa perguntas para entender o perfil do aluno\n2. Mantenha o contexto da conversa anterior\n3. Use as informa√ß√µes sobre universidades de Teresina quando relevante\n4. Seja emp√°tico e encorajador\n5. Sempre use markdown para organizar suas respostas\n6. Se o aluno quiser informa√ß√µes sobre outras cidades, adapte suas recomenda√ß√µes\n\nOrientador Profissional:`;

                    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{
                                    text: fullPrompt
                                }]
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Erro na API: ${response.status} - ${errorText}`);
                    }

                    const data = await response.json();
                    
                    if (data.candidates && data.candidates[0] && data.candidates[0].content) {
                        return data.candidates[0].content.parts[0].text;
                    } else {
                        throw new Error('Resposta inv√°lida da API');
                    }
                } catch (error) {
                    console.error('Erro ao chamar Orientador API:', error);
                    throw error;
                }
            }
            
            // ===== QUICK ACTIONS =====
            function handleQuickAction(action) {
                if (!currentAgent) {
                    showToast('Selecione um agente primeiro', 'warning');
                    return;
                }
                
                let actions = {};
                
                // A√ß√µes espec√≠ficas para o orientador
                if (currentAgent.area === 'Orienta√ß√£o') {
                    actions = {
                        summary: 'Fa√ßa um resumo completo do meu perfil profissional e das recomenda√ß√µes que voc√™ me deu at√© agora. Inclua pontos fortes, √°reas de interesse e pr√≥ximos passos.',
                        flashcards: 'Crie um guia de estudo personalizado para o ENEM baseado no meu perfil. Inclua dicas espec√≠ficas para as √°reas que preciso focar.',
                        questions: 'Me ajude a criar um cronograma de estudos para o ENEM considerando minhas prefer√™ncias e objetivos profissionais.',
                        schedule: 'Analise as universidades de Teresina e me d√™ um ranking das melhores op√ß√µes para o curso que estou interessado, incluindo notas de corte e estrutura.'
                    };
                } else {
                    // A√ß√µes para outros agentes
                    actions = {
                        summary: 'Crie um resumo completo e estruturado do conte√∫do que discutimos, com os pontos principais, conceitos-chave e exemplos importantes. Organize de forma did√°tica para facilitar o estudo.',
                        flashcards: 'Crie 10 flashcards para revis√£o do conte√∫do que discutimos. Cada flashcard deve ter uma pergunta na frente e a resposta no verso. Foque nos conceitos mais importantes.',
                        questions: 'Crie 5 quest√µes de revis√£o sobre o conte√∫do que discutimos. Inclua diferentes tipos de quest√µes (m√∫ltipla escolha, verdadeiro/falso, dissertativa) para testar a compreens√£o.',
                        schedule: 'Crie um cronograma de estudos de 1 semana para revisar o conte√∫do que discutimos. Inclua hor√°rios, t√≥picos espec√≠ficos e dicas de como estudar de forma eficiente.'
                    };
                }
                
                const message = actions[action];
                if (message) {
                    document.getElementById('message-input').value = message;
                    document.getElementById('send-btn').click();
                }
            }
            
            // ===== DELETE CONVERSATION =====
            function deleteConversation(conversationId) {
                if (confirm('Tem certeza que deseja excluir esta conversa? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    // Remove a conversa da lista
                    conversations = conversations.filter(c => c.id !== conversationId);
                    
                    // Se a conversa atual foi exclu√≠da, limpa a interface
                    if (currentConversation && currentConversation.id === conversationId) {
                        currentConversation = null;
                        currentAgent = null;
                        document.getElementById('welcome-message').classList.remove('hidden');
                        document.getElementById('chat-container').classList.add('hidden');
                        document.querySelectorAll('.agent-card').forEach(card => {
                            card.classList.remove('selected');
                        });
                    }
                    
                    // Salva as mudan√ßas
                    saveConversations();
                    
                    // Atualiza a interface
                    renderConversations();
                    
                    showToast('Conversa exclu√≠da com sucesso!', 'success');
                }
            }
            
            // ===== TOAST NOTIFICATIONS =====
            function showToast(message, type = 'success') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                
                const colors = {
                    success: 'bg-green-500',
                    error: 'bg-red-500',
                    warning: 'bg-yellow-500',
                    info: 'bg-blue-500'
                };
                
                toast.className = `${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg transform translate-x-full transition-transform duration-300`;
                toast.textContent = message;
                
                container.appendChild(toast);
                
                setTimeout(() => toast.classList.remove('translate-x-full'), 100);
                setTimeout(() => {
                    toast.classList.add('translate-x-full');
                    setTimeout(() => container.removeChild(toast), 300);
                }, 3000);
            }
            
            // ===== BOT√ÉO ESPECIAL DO DR. FUTURO =====
            function startDrFuturoMission() {
                if (!currentAgent || currentAgent.area !== 'Orienta√ß√£o') {
                    showToast('Selecione o Dr. Futuro primeiro!', 'warning');
                    return;
                }
                
                const missionMessage = `üöÄ **MISS√ÉO ESPECIAL DO DR. FUTURO** üöÄ

Ol√°, estudante! Vou conduzir voc√™ atrav√©s de uma **an√°lise profunda e personalizada** do seu futuro profissional!

**O que vamos fazer:**
1. üîç **An√°lise Completa de Perfil** - Vamos descobrir seus pontos fortes
2. üéØ **Mapeamento de Interesses** - Identificar suas paix√µes e habilidades
3. üíº **An√°lise de Mercado** - Ver as melhores oportunidades profissionais
4. üè´ **Ranking de Universidades** - Encontrar a institui√ß√£o perfeita para voc√™
5. üìà **Plano de A√ß√£o** - Criar um roteiro para o sucesso

**Vamos come√ßar?** 

Me conte um pouco sobre voc√™:
- Que mat√©rias voc√™ mais gosta na escola?
- Quais s√£o seus hobbies e interesses?
- Que tipo de trabalho voc√™ imagina fazendo no futuro?
- Tem alguma √°rea espec√≠fica que te interessa?

*Estou aqui para te ajudar a descobrir seu caminho!* ‚ú®`;

                // Adiciona a mensagem da miss√£o
                addMessage({
                    type: 'agent',
                    content: missionMessage,
                    timestamp: new Date().toISOString()
                });
                
                showToast('üöÄ Miss√£o iniciada! Vamos descobrir seu futuro!', 'success');
            }
            
            // Fun√ß√£o para buscar as anota√ß√µes do localStorage
            function getNotes() {
                return JSON.parse(localStorage.getItem('enemai_notes')) || [];
            }

            // Fun√ß√£o para abrir o modal de sele√ß√£o de anota√ß√£o
            function openNotesModal() {
                const notes = getNotes();
                const list = document.getElementById('notes-list-modal');
                list.innerHTML = '';
                if (notes.length === 0) {
                    list.innerHTML = '<div style="color:#bdbdbd;text-align:center;">Nenhuma anota√ß√£o encontrada.</div>';
                } else {
                    notes.forEach(nota => {
                        const div = document.createElement('div');
                        div.style = 'background:#2d2d3a;color:#fff;padding:0.8em 1em;border-radius:0.8em;cursor:pointer;box-shadow:0 2px 8px #0002;';
                        div.innerHTML = `<div style=\'font-weight:bold;\'>${nota.title || '(Sem t√≠tulo)'}</div><div style=\'font-size:0.95em;color:#bdbdbd;\'>${nota.content.replace(/<[^>]+>/g, '').slice(0, 60)}${nota.content.length > 60 ? '...' : ''}</div>`;
                        div.onclick = function() {
                            inserirNotaNoChat(nota);
                            closeNotesModal();
                        };
                        list.appendChild(div);
                    });
                }
                document.getElementById('notes-modal').style.display = 'flex';
            }

            function closeNotesModal() {
                document.getElementById('notes-modal').style.display = 'none';
            }

            // Fun√ß√£o para inserir a anota√ß√£o no campo de mensagem
            function inserirNotaNoChat(nota) {
                const texto = `Olhe a seguinte anota√ß√£o que fiz para meus estudos e me diga como posso melhor√°-la:\n\nT√≠tulo: ${nota.title}\nConte√∫do: ${nota.content.replace(/<[^>]+>/g, '')}\n\nD√™ sugest√µes de melhoria, clareza, estrutura e exemplos.`;
                document.getElementById('message-input').value = texto;
                document.getElementById('message-input').focus();
            }

            // ===== EVENT LISTENERS =====
            function setupEventListeners() {
                // Agent selection
                document.querySelectorAll('.agent-card').forEach(card => {
                    card.addEventListener('click', () => {
                        const agentId = card.dataset.agent;
                        selectAgent(agentId);
                    });
                });
                
                // Send message
                document.getElementById('send-btn').addEventListener('click', () => {
                    const input = document.getElementById('message-input');
                    const message = input.value.trim();
                    
                    if (message && currentAgent) {
                        sendMessage(message);
                        input.value = '';
                        updateCharCount();
                    } else if (!currentAgent) {
                        showToast('Selecione um agente primeiro', 'warning');
                    }
                });
                
                // Enter key to send
                document.getElementById('message-input').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        document.getElementById('send-btn').click();
                    }
                });
                
                // Character count
                document.getElementById('message-input').addEventListener('input', updateCharCount);
                
                // Clear conversation
                document.getElementById('clear-btn').addEventListener('click', () => {
                    if (confirm('Tem certeza que deseja limpar esta conversa?')) {
                        if (currentConversation) {
                            if (currentConversation.isTemporary) {
                                // Se √© tempor√°ria, apenas limpa as mensagens
                                currentConversation.messages = [];
                                renderMessages();
                            } else {
                                // Se √© salva, limpa e atualiza
                                currentConversation.messages = [];
                                saveConversations();
                                renderMessages();
                                renderConversations();
                            }
                        }
                    }
                });
                
                // New chat
                document.getElementById('new-chat-btn').addEventListener('click', () => {
                    document.getElementById('welcome-message').classList.remove('hidden');
                    document.getElementById('chat-container').classList.add('hidden');
                    currentConversation = null;
                    currentAgent = null;
                    document.querySelectorAll('.agent-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                });
                
                // Quick actions
                document.querySelectorAll('.quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const action = btn.dataset.action;
                        handleQuickAction(action);
                    });
                });
                
                // Navigation
                document.getElementById('main-dashboard-btn').addEventListener('click', () => {
                    window.location.href = 'main-dashboard.html';
                });
                
                document.getElementById('logout-btn').addEventListener('click', logout);
                
                // Start mission
                document.getElementById('start-mission-btn').addEventListener('click', startDrFuturoMission);

                // Community button
                document.getElementById('community-btn').onclick = function() {
                    window.location.href = 'community.html';
                };

                // Settings button
                document.getElementById('settings-btn').onclick = function() {
                    window.location.href = 'settings.html';
                };

                // Use note button
                document.getElementById('use-note-btn').addEventListener('click', openNotesModal);
            }
            
            function updateCharCount() {
                const input = document.getElementById('message-input');
                const count = input.value.length;
                document.getElementById('char-count').textContent = count;
                
                if (count > 1000) {
                    input.value = input.value.substring(0, 1000);
                    document.getElementById('char-count').textContent = '1000';
                }
            }
            
            // ===== INITIALIZATION =====
            function init() {
                initAuth();
                conversations = getConversations();
                renderConversations();
                setupEventListeners();
                updateCharCount();
            }
            
            // Make deleteConversation globally available
            window.deleteConversation = deleteConversation;
            
            // Start the application
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
            
        })();

        // Anima√ß√£o sequencial de fade-in usando Intersection Observer
        document.addEventListener('DOMContentLoaded', function() {
            const sections = Array.from(document.querySelectorAll('.fade-section'));
            let delay = 0;
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach((entry, idx) => {
                    if (entry.isIntersecting) {
                        setTimeout(() => {
                            entry.target.classList.add('visible');
                        }, delay);
                        delay += 400;
                        obs.unobserve(entry.target);
                    }
                });
            }, { threshold: 0.2 });
            sections.forEach(section => {
                observer.observe(section);
            });
        });

        document.getElementById('sidebar-toggle').onclick = function() {
            document.body.classList.toggle('sidebar-collapsed');
            document.getElementById('sidebar').classList.toggle('collapsed');
        };
    </script>
</body>
</html> 